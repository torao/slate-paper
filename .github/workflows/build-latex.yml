name: Build XeLaTeX PDF

on:
  push:
    branches:
      - main
    paths:
      - '**.tex'
      - '**.bib'
      - 'figures/**'
      - 'images/**'
      - '.github/workflows/build-latex.yml'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install TeX Live and Fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            texlive-xetex \
            texlive-latex-extra \
            texlive-fonts-extra \
            texlive-lang-japanese \
            texlive-lang-cjk \
            texlive-bibtex-extra \
            biber \
            fonts-noto-cjk \
            texlive-publishers \
            fonts-noto-cjk-extra \
            fonts-noto-mono \
            latexmk \
            texlive-lang-chinese \
            texlive-fonts-recommended \
            texlive-plain-generic
          
          # フォントキャッシュの更新
          fc-cache -fv

      - name: Verify IEEEtran.bst availability
        run: |
          kpsewhich IEEEtran.bst || {
            echo "ERROR: IEEEtran.bst not found"
            echo "Installing from CTAN..."
            wget -q http://mirrors.ctan.org/macros/latex/contrib/IEEEtran/bibtex/IEEEtran.bst
            mkdir -p ~/texmf/bibtex/bst/IEEEtran
            mv IEEEtran.bst ~/texmf/bibtex/bst/IEEEtran/
            texhash ~/texmf
          }
      
      - name: Verify Japanese Font Installation
        run: |
          fc-list :lang=ja | grep -i "noto" || echo "Warning: Noto CJK fonts may not be properly installed"
      
      - name: Compile with XeLaTeX
        run: |
          latexmk \
            -xelatex \
            -synctex=1 \
            -interaction=nonstopmode \
            -file-line-error \
            -halt-on-error \
            main.tex

      - name: Verify and rename PDF
        run: |
          if [ ! -f main.pdf ]; then
            echo "Error: main.pdf not found in artifact"
            ls -la
            exit 1
          fi
          cp main.pdf slate-SNAPSHOT.pdf
          ls -lh slate-SNAPSHOT.pdf

      - name: Delete existing SNAPSHOT release
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release delete SNAPSHOT --yes 2>/dev/null || true
          # API反映待機 (削除直後の作成で409 Conflictを避ける)
          sleep 3

      - name: Delete and recreate SNAPSHOT tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # リモートタグ削除（エラーは無視）
          git push origin :refs/tags/SNAPSHOT 2>/dev/null || true
          
          # ローカルタグ削除→再作成
          git tag -d SNAPSHOT 2>/dev/null || true
          git tag SNAPSHOT ${{ github.sha }}
          
          # リモートにプッシュ（強制）
          git push origin SNAPSHOT

      - name: Create SNAPSHOT release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create SNAPSHOT \
            slate-SNAPSHOT.pdf \
            --title "Latest Snapshot" \
            --notes "**Commit:** \`${{ github.sha }}\`
          **Built:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          **Workflow Run:** https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          This is an automated latest snapshot."
